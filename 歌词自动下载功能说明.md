# 歌词自动下载功能说明

## 功能概述

mPlayer 现在支持自动从网络下载歌词功能。当本地找不到音乐的歌词时，应用会自动尝试从多个在线歌词源搜索并下载相应的歌词文件。

## 主要特性

### 1. 智能歌词搜索
- **多源搜索**: 同时从多个歌词源搜索，包括：
  - 网易云音乐
  - LrcLib (开源歌词库)
  - Genius (预留接口)
- **智能匹配**: 使用字符串相似度算法计算匹配度
- **自动排序**: 按匹配度自动选择最佳结果

### 2. 自动下载流程
1. 播放歌曲时，首先检查本地歌词库
2. 如果没有找到，尝试从本地文件加载
3. 如果仍然没有找到，自动启动在线搜索
4. 下载成功后自动保存到本地，供下次使用

### 3. 手动重新加载
- **重新加载按钮**: 在歌词控制栏提供重新加载选项
- **两种模式**:
  - 从本地重新加载：重新扫描本地歌词文件
  - 在线下载歌词：强制从网络搜索下载

### 4. 用户界面增强
- **下载进度显示**: 实时显示搜索和下载进度
- **错误信息提示**: 清晰显示下载失败原因
- **一键下载按钮**: 在无歌词页面提供便捷的下载入口

## 技术实现

### 核心组件

#### 1. LyricsSearchAPI
- 负责从多个歌词源搜索歌词
- 使用 async/await 进行并发搜索
- 实现智能匹配算法

#### 2. LyricsDownloadService
- 管理下载状态和进度
- 协调搜索API和歌词管理器
- 处理错误和重试逻辑

#### 3. LyricsManager (增强)
- 新增 `reloadLyrics` 方法
- 集成在线下载功能
- 优化加载流程

### 搜索算法

#### 匹配度计算
```swift
匹配度 = 歌曲标题相似度 × 0.6 + 艺术家相似度 × 0.4
```

#### 字符串相似度
使用 Levenshtein 距离算法计算字符串相似度：
```swift
相似度 = (字符串长度 - 编辑距离) / 字符串长度
```

## 使用方法

### 自动下载
1. 播放任意歌曲
2. 如果本地没有歌词，应用会自动开始搜索
3. 搜索成功后歌词会自动显示并保存到本地

### 手动重新加载
1. 在歌词页面点击控制栏的"重载"按钮
2. 选择加载方式：
   - "从本地重新加载"：重新扫描本地文件
   - "在线下载歌词"：从网络重新搜索下载

### 无歌词页面操作
1. 当显示"暂无歌词"时
2. 点击"在线搜索歌词"按钮
3. 等待搜索完成

## 文件存储

### 本地存储位置
- 歌词文件保存在应用的 Documents 目录
- 文件命名格式：`艺术家 - 歌曲标题.lrc`
- 支持 LRC 和 TXT 格式

### 歌词库管理
- 所有歌词信息存储在 UserDefaults 中
- 支持歌词的增删改查操作
- 自动关联歌曲ID和歌词文件

## 网络权限

应用已配置必要的网络访问权限：
```xml
<key>com.apple.security.network.client</key>
<true/>
```

## 错误处理

### 常见错误类型
- **网络连接失败**: 检查网络连接
- **未找到匹配歌词**: 尝试手动搜索或检查歌曲信息
- **解析失败**: 歌词格式不支持
- **请求频率限制**: 稍后重试

### 错误恢复
- 自动重试机制
- 多源备用方案
- 保持无歌词状态

## 性能优化

### 并发搜索
- 同时从多个源搜索，提高成功率
- 使用 async/await 避免阻塞主线程

### 缓存机制
- 本地歌词库缓存
- 避免重复下载相同歌词

### 网络优化
- 合理的超时设置
- 请求头优化
- 错误重试策略

## 隐私保护

- 仅在用户主动触发时进行网络请求
- 不收集用户个人信息
- 搜索记录不会上传到服务器

## 未来扩展

### 计划功能
1. 支持更多歌词源
2. 歌词翻译功能
3. 用户自定义歌词源
4. 批量下载歌词
5. 歌词质量评分系统

### API 扩展
1. Genius API 完整实现
2. 其他音乐平台API接入
3. 本地歌词数据库同步

## 注意事项

1. **网络依赖**: 在线下载功能需要网络连接
2. **API限制**: 某些歌词源可能有请求频率限制
3. **版权问题**: 请遵守相关歌词版权规定
4. **准确性**: 自动匹配可能不是100%准确，建议人工确认

## 故障排除

### 下载失败
1. 检查网络连接
2. 确认歌曲信息准确性
3. 尝试手动重新加载
4. 查看错误日志

### 匹配不准确
1. 检查歌曲标题和艺术家信息
2. 尝试不同的搜索关键词
3. 手动选择合适的歌词文件

### 性能问题
1. 清理歌词缓存
2. 重启应用
3. 检查设备存储空间 